<!-- lista-usuario.component.html -->
<div class="usuario-container">
  <h2><i class="fas fa-users"></i> Gestión de Usuarios</h2>
  <p>Administra los usuarios del sistema y sus permisos.</p>

  <div class="card-container">
    <div class="summary-card">
      <div class="card-icon bg-primary">
        <i class="fas fa-user-tie"></i>
      </div>
      <div class="card-info">
        <h3>{{contarUsuariosPorRol('Administrador')}}</h3>
        <p>Administrador(es)</p>
      </div>
    </div>

    <div class="summary-card">
      <div class="card-icon bg-info">
        <i class="fas fa-boxes"></i>
      </div>
      <div class="card-info">
        <h3>{{contarUsuariosPorRol('Almacenero')}}</h3>
        <p>Almacenero(s)</p>
      </div>
    </div>

    <div class="summary-card">
      <div class="card-icon bg-success">
        <i class="fas fa-cash-register"></i>
      </div>
      <div class="card-info">
        <h3>{{contarUsuariosPorRol('Vendedor')}}</h3>
        <p>Vendedor(es)</p>
      </div>
    </div>
  </div>

  <div class="actions">
    <!-- Show "Nuevo Usuario" button only if user is Administrator -->
    <button class="btn btn-primary" (click)="abrirModalNuevo()" *ngIf="isAdministrator()">
      <i class="fas fa-plus"></i> Nuevo Usuario
    </button>
    <div class="input-group search-box">
      <input type="text" class="form-control" placeholder="Buscar usuario..." [(ngModel)]="filtro" (input)="filtrarUsuarios()">
      <div class="input-group-append">
        <span class="input-group-text"><i class="fas fa-search"></i></span>
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Nombre Completo</th>
          <th>Email</th>
          <th>Rol</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let usuario of usuariosFiltrados">
          <td>{{ usuario.idUsuario }}</td>
          <td>{{ usuario.username }}</td>
          <td>{{ usuario.nombreCompleto }}</td>
          <td>{{ usuario.email }}</td>
          <td>{{ usuario.nombreRol }}</td>
          <td>
            <!-- View button visible to all users with web roles -->
            <button class="btn btn-sm btn-info" (click)="verUsuario(usuario)" title="Ver" *ngIf="hasAnyRole(['Administrador', 'Vendedor', 'Almacenero'])">
              <i class="fas fa-eye"></i>
            </button>
            <!-- Edit button visible only if user is Administrator -->
            <button class="btn btn-sm btn-warning" (click)="editarUsuario(usuario)" title="Editar" *ngIf="isAdministrator()">
              <i class="fas fa-edit"></i>
            </button>
             <!-- Delete button visible only if user is Administrator -->
             <button class="btn btn-sm btn-danger" (click)="eliminarUsuario(usuario)" title="Eliminar" *ngIf="isAdministrator()">
                <i class="fas fa-trash"></i>
             </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal Usuario -->
  <div class="modal fade" [class.show]="mostrarModal" [style.display]="mostrarModal ? 'block' : 'none'">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas" [class.fa-user-plus]="!usuarioSeleccionado.idUsuario" [class.fa-user-edit]="usuarioSeleccionado.idUsuario"></i>
            {{ usuarioSeleccionado.idUsuario ? 'Editar Usuario' : 'Nuevo Usuario' }}
          </h5>
          <button type="button" class="close" (click)="cerrarModal()">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form #usuarioForm="ngForm">
            <div class="form-group">
              <label>Nombre Completo</label>
              <input type="text" class="form-control" [(ngModel)]="usuarioSeleccionado.nombreCompleto" name="nombreCompleto" required>
            </div>
             <div class="form-group">
              <label>Username</label>
              <input type="text" class="form-control" [(ngModel)]="usuarioSeleccionado.username" name="username" required>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" class="form-control" [(ngModel)]="usuarioSeleccionado.email" name="email" required>
            </div>
             <div class="form-group">
                <label>Teléfono</label>
                <input type="text" class="form-control" [(ngModel)]="usuarioSeleccionado.telefono" name="telefono">
             </div>
            <div class="form-group">
              <label>Rol</label>
              <select class="form-control" [(ngModel)]="usuarioSeleccionado.idRol" name="idRol" required>
                <option [value]="0" disabled selected>Seleccione Rol</option>
                <option *ngFor="let rol of roles" [value]="rol.idRol">{{ rol.nombre }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Contraseña</label>
              <div class="input-group">
                <input [type]="mostrarPassword ? 'text' : 'password'" class="form-control"
                       [(ngModel)]="usuarioSeleccionado.password" name="password" [required]="!usuarioSeleccionado.idUsuario">
                <div class="input-group-append">
                  <button class="btn btn-outline-secondary" type="button" (click)="mostrarPassword = !mostrarPassword">
                    <i class="fas" [class.fa-eye]="!mostrarPassword" [class.fa-eye-slash]="mostrarPassword"></i>
                  </button>
                </div>
              </div>
              <small class="text-muted" *ngIf="usuarioSeleccionado.idUsuario">Dejar en blanco para no cambiar la contraseña</small>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="button" class="btn btn-primary" (click)="guardarUsuario()" [disabled]="!usuarioForm.form.valid">
            <i class="fas fa-save"></i> Guardar
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade" [class.show]="mostrarModal" [style.display]="mostrarModal ? 'block' : 'none'"></div>
</div>