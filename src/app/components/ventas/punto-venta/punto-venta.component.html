<!-- punto-venta.component.html -->

<!-- Modal de confirmación -->
<div *ngIf="mostrarConfirmacion" class="modal-backdrop" (click)="cancelarComprobante()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h4 class="text-success">✔ Venta registrada correctamente</h4>
    <div class="mt-4 text-end">
      <button class="btn btn-primary me-2" (click)="imprimirComprobante()">Imprimir Comprobante</button>
      <button class="btn btn-secondary" (click)="cancelarComprobante()">Cancelar</button>
    </div>
  </div>
</div>

<form #ventaForm="ngForm" (ngSubmit)="realizarVenta(ventaForm)" novalidate>
  <div class="punto-venta-wrapper">
    <div class="punto-venta-container">

      <!-- IZQUIERDA: Búsqueda & Tabla -->
      <div class="venta-left">
        <div class="venta-top-bar">

          <!-- Autocomplete -->
          <div class="venta-search">
            <label>Productos</label>
            <ng-autocomplete
              [data]="productosAutoComplete"
              [searchKeyword]="keyword"
              [(ngModel)]="productoBuscado"
              name="productoBuscado"
              (selected)="selectEvent($event)"
              (inputChanged)="onChangeSearch($event)"
              (inputFocused)="onFocused($event)"
              [itemTemplate]="itemTemplate"
              [notFoundTemplate]="notFoundTemplate"
              placeholder="Ingrese código o nombre">
            </ng-autocomplete>
            <ng-template #itemTemplate let-item>
              <div>{{ item.nombre }} - {{ item.codigo }}</div>
            </ng-template>
            <ng-template #notFoundTemplate let-notFound>
              <div>{{ notFound }}</div>
            </ng-template>
          </div>

          <!-- Total -->
          <div class="venta-amount">
            <h3>Gs/ {{ total.toFixed(2) }}</h3>
          </div>

          <!-- Botones -->
          <div class="venta-buttons">
            <button type="submit" class="btn btn-primary">Realizar Venta</button>
            <button type="button" class="btn btn-danger" (click)="vaciarListado()">Vaciar Listado</button>
          </div>
        </div>

        <!-- Tabla Ítems -->
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Item</th><th>Código</th><th>Producto</th><th>Cant.</th><th>Precio</th><th>Total</th><th>Opc.</th><th>Talla</th><th>Stock</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let it of ventaItems; let i = index">
              <td>{{ it.item }}</td>
              <td>{{ it.codigo }}</td>
              <td>{{ it.nombre }}</td>
              <td>
                <input type="number" min="1" [(ngModel)]="it.cantidad" name="cant{{i}}"
                       (change)="cambiarCantidad(i, it.cantidad)" style="width:50px" />
              </td>
              <td>Gs/ {{ it.precio.toFixed(2) }}</td>
              <td>Gs/ {{ (it.cantidad * it.precio).toFixed(2) }}</td>
              <td><button class="btn btn-sm btn-danger" (click)="eliminarItem(i)">Quitar</button></td>
              <td><span class="talla-link" (click)="mostrarTallas(it, i)">{{ it.talla || '---' }}</span></td>
              <td>{{ it.stock }}</td>
            </tr>
            <tr *ngIf="ventaItems.length === 0">
              <td colspan="9" class="text-center">No hay datos</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- DERECHA: Cabecera Venta -->
      <div class="venta-right">
        <div class="venta-right-group">
          <label>Documento *</label>
          <select class="form-select" [(ngModel)]="documentoSeleccionado" name="doc" (ngModelChange)="onDocumentoChange()" required>
            <option value="">Seleccione</option>
            <option>Boleta</option>
            <option>Factura</option>
          </select>
        </div>
        <div class="venta-right-group">
          <label>Cliente *</label>
          <div style="display:flex; gap:5px">
            <select class="form-select" [(ngModel)]="clienteSeleccionado" name="cli" required>
              <option value="">Seleccione</option>
              <option *ngFor="let c of personas">{{ c.numeroDocumento }} - {{ c.nombre }}</option>
            </select>
            <button type="button" class="btn btn-success btn-sm" (click)="abrirModalCliente()">+</button>
          </div>
        </div>
        <div class="venta-right-group">
          <label>Medio Pago *</label>
          <select class="form-select" [(ngModel)]="tipoPagoSeleccionado" name="mp" required>
            <option value="">Seleccione</option>
            <option *ngFor="let m of mediosPago">{{ m }}</option>
          </select>
        </div>
        <div class="venta-right-group">
          <label>Serie *</label>
          <input class="form-control" [(ngModel)]="serie" name="ser" readonly />
        </div>
        <div class="venta-right-group">
          <label>Correlativo *</label>
          <input class="form-control" [(ngModel)]="correlativo" name="cor" readonly />
        </div>
        <div class="venta-right-group">
          <label>Efectivo Recibido *</label>
          <input type="number" min="0" class="form-control" [(ngModel)]="montoEfectivo" name="ef" required />
        </div>
        <div class="venta-right-group">
          <p class="text-danger">Recibido: Gs/ {{ montoEfectivo.toFixed(2) }}</p>
          <p class="text-danger">Vuelto: Gs/ {{ vuelto.toFixed(2) }}</p>
        </div>
        <div class="venta-right-group">
          <p>SUBTOTAL: Gs/ {{ subTotal.toFixed(2) }}</p>
          <p>IGV (18%): Gs/ {{ iva.toFixed(2) }}</p>
          <p>DESCUENTO: Gs/ {{ descuento.toFixed(2) }}</p>
          <p class="fw-bold">TOTAL: Gs/ {{ total.toFixed(2) }}</p>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- Modal Tallas -->
<div class="modal-backdrop" *ngIf="mostrarModalTallas" (click)="cerrarModalTallas()"></div>
<div class="modal-content" *ngIf="mostrarModalTallas" (click)="$event.stopPropagation()">
  <h4>Elige una Talla</h4>
  <hr />
  <table class="table table-bordered table-sm">
    <thead>
      <tr><th>USA/EUR/CM</th><th>Stock</th><th>Acción</th></tr>
    </thead>
    <tbody>
      <tr *ngFor="let t of tallasProducto">
        <td>{{ t.usa }}/{{ t.eur }}/{{ t.cm }}</td>
        <td>{{ t.stock }}</td>
        <td><button class="btn btn-sm btn-primary" (click)="seleccionarTalla(t)">Seleccionar</button></td>
      </tr>
      <tr *ngIf="tallasProducto.length === 0"><td colspan="3">No hay tallas</td></tr>
    </tbody>
  </table>
  <div class="text-end"><button class="btn btn-secondary" (click)="cerrarModalTallas()">Cerrar</button></div>
</div>

<!-- Modal Cliente -->
<div class="modal-backdrop" *ngIf="mostrarModalCliente" (click)="cerrarModalCliente()"></div>
<div class="modal-content" *ngIf="mostrarModalCliente" (click)="$event.stopPropagation()" style="width:500px">
  <app-persona-form (onCancelar)="cerrarModalCliente()" (onGuardar)="manejarPersonaCreada($event)"></app-persona-form>
</div>

<!-- Bloque oculto para impresión -->
<div style="display:none" #reporteBoletaContainer>
  <app-boleta-venta
    *ngIf="boleta"
    [venta]="boleta">
  </app-boleta-venta>
</div>

