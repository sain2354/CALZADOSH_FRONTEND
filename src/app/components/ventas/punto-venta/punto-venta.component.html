<!-- punto-venta.component.html -->

<!-- Modal de confirmación -->
<div *ngIf="mostrarConfirmacion" class="modal-backdrop" (click)="cancelarComprobante()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h4 class="text-success">✔ Venta registrada correctamente</h4>
    <div class="mt-4 text-end">
      <button class="btn btn-primary me-2" (click)="imprimirComprobante()">Imprimir Comprobante</button>
      <button class="btn btn-secondary" (click)="cancelarComprobante()">Cancelar</button>
    </div>
  </div>
</div>

<form #ventaForm="ngForm" (ngSubmit)="realizarVenta(ventaForm)" novalidate>
  <div class="pv-wrapper">

    <!-- Contenedor principal con left + right -->
    <div class="pv-container">

      <!-- PANEL IZQUIERDO -->
      <div class="pv-left">
        <!-- Barra superior: buscador full width -->
        <div class="search-row">
          <label class="label-small">Productos</label>
          <ng-autocomplete
            [data]="productosAutoComplete"
            [searchKeyword]="keyword"
            [(ngModel)]="productoBuscado"
            name="productoBuscado"
            (selected)="selectEvent($event)"
            (inputChanged)="onChangeSearch($event)"
            (inputFocused)="onFocused($event)"
            [itemTemplate]="itemTemplate"
            [notFoundTemplate]="notFoundTemplate"
            placeholder="Ingrese el código de barras o el nombre del producto">
          </ng-autocomplete>

          <ng-template #itemTemplate let-item>
            <div>{{ item.nombre }} - {{ item.codigo }}</div>
          </ng-template>
          <ng-template #notFoundTemplate let-notFound>
            <div>{{ notFound }}</div>
          </ng-template>
        </div>

        <!-- fila del monto grande y botones al lado -->
        <div class="top-panel">
          <div class="big-amount-box">
            <span class="moneda">S/</span>
            <span class="monto">{{ total.toFixed(2) }}</span>
          </div>

          <div class="action-buttons">
            <button type="submit" class="btn btn-primary btn-action"><i class="bi bi-cart3"></i> Realizar Venta</button>
            <button type="button" class="btn btn-danger btn-action" (click)="vaciarListado()"><i class="bi bi-trash"></i> Vaciar Listado</button>
          </div>
        </div>

        <!-- Controles Ver/Buscar (debajo) -->
        <div class="controls-row">
          <div class="ver">
            <label>Ver</label>
            <select class="form-select select-compact" [(ngModel)]="itemsPerPage" name="itemsPerPage">
              <option *ngFor="let opt of itemsPerPageOptions" [value]="opt">{{ opt }}</option>
            </select>
          </div>
          <div class="buscar">
            <label class="label-invisible"></label>
            <div class="buscar-inline">
              <span class="buscar-label">Buscar:</span>
              <input type="text" class="form-control input-search" placeholder="" [(ngModel)]="searchTerm" name="searchTerm" />
            </div>
          </div>
        </div>

        <!-- Tabla -->
        <div class="table-card">
          <table class="table custom-table">
            <thead>
              <tr>
                <th>Item</th><th>Codigo</th><th>Producto</th><th>Cantidad</th><th>Precio</th><th>Total</th><th>Opc.</th><th>Talla</th><th>Stock</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let it of filteredVentaItems | paginate: { itemsPerPage: itemsPerPage, currentPage: currentPage } ; let i = index">
                <td>{{ it.item }}</td>
                <td>{{ it.codigo }}</td>
                <td>{{ it.nombre }}</td>
                <td>
                  <input type="number" min="1" [(ngModel)]="it.cantidad" name="cant{{it.item}}"
                         (change)="cambiarCantidad(getGlobalIndex(i), it.cantidad)" class="input-cant" />
                </td>
                <td>S/ {{ it.precio.toFixed(2) }}</td>
                <td>S/ {{ (it.cantidad * it.precio).toFixed(2) }}</td>
                <td><button class="btn btn-sm btn-danger" (click)="eliminarItem(getGlobalIndex(i))">Quitar</button></td>
                <td><span class="talla-link" (click)="mostrarTallas(it, getGlobalIndex(i))">{{ it.talla || '---' }}</span></td>
                <td>{{ it.stock }}</td>
              </tr>

              <tr *ngIf="filteredVentaItems.length === 0">
                <td colspan="9" class="text-center">No hay información en esta tabla</td>
              </tr>
            </tbody>
          </table>

          <!-- Pie: ahora solo paginador (el texto de registros fue eliminado) -->
          <div class="table-footer">
            <div class="paginador-only">
              <pagination-controls (pageChange)="pageChanged($event)" [maxSize]="5" [directionLinks]="true" [autoHide]="false"
                                   previousLabel="Anterior" nextLabel="Siguiente">
              </pagination-controls>
            </div>
            <div class="empty-placeholder"></div>
          </div>
        </div>
      </div>

      <!-- PANEL DERECHO (tarjeta fija similar a captura) -->
      <div class="pv-right">
        <div class="right-card">
          <div class="form-group">
            <label>Documento*</label>
            <select class="form-select" [(ngModel)]="documentoSeleccionado" name="doc" (ngModelChange)="onDocumentoChange()" required>
              <option value="">Seleccione</option>
              <option>Boleta</option>
              <option>Factura</option>
            </select>
          </div>

          <div class="form-group">
            <label>Cliente*</label>
            <div class="cliente-row">
              <select class="form-select" [(ngModel)]="clienteSeleccionado" name="cli" required>
                <option value="">Seleccione</option>
                <option *ngFor="let c of personas">{{ c.numeroDocumento }} - {{ c.nombre }}</option>
              </select>
              <button type="button" class="btn btn-add" (click)="abrirModalCliente()">+</button>
            </div>
          </div>

          <div class="form-group">
            <label>Tipo Pago*</label>
            <select class="form-select" [(ngModel)]="tipoPagoSeleccionado" name="mp" required>
              <option value="">Seleccione Tipo Pago</option>
              <option *ngFor="let m of mediosPago">{{ m }}</option>
            </select>
          </div>

          <div class="serie-correlativo">
            <div>
              <label>Serie</label>
              <input class="form-control input-read" [(ngModel)]="serie" name="ser" readonly />
            </div>
            <div>
              <label>Correlativo</label>
              <input class="form-control input-read" [(ngModel)]="correlativo" name="cor" readonly />
            </div>
          </div>

          <div class="form-group">
            <label>Efectivo recibido</label>
            <input type="number" min="0" class="form-control" [(ngModel)]="montoEfectivo" name="ef" />
          </div>

          <div class="checkbox-row">
            <label><input type="checkbox" />  Efectivo Exacto</label>
          </div>

          <div class="amounts">
            <p class="monto-efect">Monto Efectivo: S/ {{ montoEfectivo.toFixed(2) }}</p>
            <p class="vuelto">Vuelto: S/ {{ vuelto.toFixed(2) }}</p>
          </div>

          <div class="totales-right">
            <div class="line"><span>SUBTOTAL</span><span>S/ {{ subTotal.toFixed(2) }}</span></div>
            <div class="line"><span>IGV (18%)</span><span>S/ {{ iva.toFixed(2) }}</span></div>
            <div class="line"><span>DESCUENTO</span><span>S/ {{ descuento.toFixed(2) }}</span></div>
            <div class="line total"><span>TOTAL</span><span>S/ {{ total.toFixed(2) }}</span></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</form>

<!-- Modal Tallas -->
<div class="modal-backdrop" *ngIf="mostrarModalTallas" (click)="cerrarModalTallas()"></div>
<div class="modal-content" *ngIf="mostrarModalTallas" (click)="$event.stopPropagation()">
  <h4>Elige una Talla</h4>
  <hr />
  <table class="table table-bordered table-sm">
    <thead>
      <tr><th>USA/EUR/CM</th><th>Stock</th><th>Acción</th></tr>
    </thead>
    <tbody>
      <tr *ngFor="let t of tallasProducto">
        <td>{{ t.usa }}/{{ t.eur }}/{{ t.cm }}</td>
        <td>{{ t.stock }}</td>
        <td><button class="btn btn-sm btn-primary" (click)="seleccionarTalla(t)">Seleccionar</button></td>
      </tr>
      <tr *ngIf="tallasProducto.length === 0"><td colspan="3">No hay tallas</td></tr>
    </tbody>
  </table>
  <div class="text-end"><button class="btn btn-secondary" (click)="cerrarModalTallas()">Cerrar</button></div>
</div>

<!-- Modal Cliente -->
<div class="modal-backdrop" *ngIf="mostrarModalCliente" (click)="cerrarModalCliente()"></div>
<div class="modal-content" *ngIf="mostrarModalCliente" (click)="$event.stopPropagation()" style="width:500px">
  <app-persona-form (onCancelar)="cerrarModalCliente()" (onGuardar)="manejarPersonaCreada($event)"></app-persona-form>
</div>

<!-- Bloque oculto para impresión -->
<div style="display:none" #reporteBoletaContainer>
  <app-boleta-venta
    *ngIf="boleta"
    [venta]="boleta">
  </app-boleta-venta>
</div>