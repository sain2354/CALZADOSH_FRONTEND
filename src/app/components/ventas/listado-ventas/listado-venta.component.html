<div class="card listado-ventas-container">
  <div class="card-header header-titulo">
    <h4 class="mb-0">Listado de Ventas</h4>
  </div>

  <div class="card-body">

    <!-- FILTROS -->
    <div class="row mb-3 align-items-end bg-light p-3 rounded border">
      <div class="col-md-4">
        <label for="busqueda" class="form-label fw-semibold">Buscar:</label>
        <div class="input-group">
          <span class="input-group-text"><i class="fa fa-search"></i></span>
          <input
            type="text"
            id="busqueda"
            class="form-control"
            placeholder="Buscar por cliente, comprobante..."
            [(ngModel)]="textoBusqueda"
            (input)="aplicarFiltros()" />
        </div>
      </div>
      <div class="col-md-3">
        <label for="fechaInicio" class="form-label fw-semibold">Fecha Inicio:</label>
        <input
          type="date"
          id="fechaInicio"
          class="form-control"
          [(ngModel)]="fechaInicio" />
      </div>
      <div class="col-md-3">
        <label for="fechaFin" class="form-label fw-semibold">Fecha Fin:</label>
        <input
          type="date"
          id="fechaFin"
          class="form-control"
          [(ngModel)]="fechaFin" />
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button class="btn btn-primary btn-sm w-100" (click)="aplicarFiltros()">
          <i class="fa fa-filter me-1"></i> Filtrar
        </button>
        <button class="btn btn-secondary btn-sm ms-2" (click)="limpiarFiltros()" title="Limpiar Filtros">
          <i class="fa fa-eraser"></i>
        </button>
      </div>
    </div>

    <!-- ACCIONES Y PAGINACIÓN -->
    <div class="d-flex justify-content-between mb-3 acciones-rapidas">
      <div class="botones-export">
        <!-- Icono que abre PDF y lanza diálogo de impresión (todas las ventas) -->
        <button
          class="btn btn-secondary btn-sm"
          title="Abrir para imprimir (todas las ventas)"
          (click)="imprimirListado()">
          <i class="fa fa-print" aria-hidden="true"></i>
        </button>

        <!-- Botón Exportar Excel con texto "EXCEL" -->
        <button
          class="btn btn-success btn-sm ms-2"
          title="Exportar a Excel (todas las ventas)"
          (click)="exportExcel()">
          EXEL
        </button>
      </div>

      <div class="d-flex align-items-center">
        <span class="me-2 text-secondary fw-semibold" style="font-size: 0.85rem;">Mostrar:</span>
        <select
          class="form-select form-select-sm"
          style="width: 70px;"
          [(ngModel)]="cantidadPorPagina"
          (change)="paginaActual = 1">
          <option [value]="5">5</option>
          <option [value]="10">10</option>
          <option [value]="25">25</option>
          <option [value]="50">50</option>
        </select>
      </div>
    </div>

    <!-- TABLA DE VENTAS (visible con paginación) -->
    <div class="table-responsive" id="listado-para-imprimir">
      <table class="table table-striped table-hover table-bordered align-middle table-sm">
        <thead class="table-encabezado">
          <tr>
            <th class="text-center">Cliente</th>
            <th class="text-center">Comprobante</th>
            <th class="text-center">Correlativo</th>
            <th class="text-center">Monto</th>
            <th class="text-center">Fecha</th>
            <th class="text-center">Estado</th>
            <th class="text-center">Opciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="ventasFiltradas.length === 0">
            <td colspan="7" class="text-center text-muted py-3">
              No se encontraron ventas con los filtros aplicados.
            </td>
          </tr>
          <tr *ngFor="let venta of ventasFiltradas | paginate: { itemsPerPage: cantidadPorPagina, currentPage: paginaActual }">
              <td class="text-center">{{ venta.clienteNombre || 'N/A' }}</td>
              <td class="text-center">{{ venta.tipoComprobante }}</td>
              <td class="text-center">{{ venta.serie }}-{{ venta.numeroComprobante }}</td>
              <td class="text-center">S/ {{ venta.total | number:'1.2-2' }}</td>
              <td class="text-center">{{ venta.fecha | date:'dd/MM/yyyy hh:mm a':'GMT-0500' }}</td>

              <td class="text-center">
                  <span class="badge"
                      [ngClass]="{
                          'bg-success': venta.estado === 'REGISTRADA' || venta.estado === 'Emitido',
                          'bg-danger': venta.estado === 'ANULADA',
                          'bg-warning': venta.estado === 'PENDIENTE'
                      }">
                      {{ venta.estado }}
                  </span>
              </td>
              <td class="text-center opciones-columna">
                  <button class="btn btn-info btn-sm" title="Ver Detalle" (click)="verDetalle(venta)">
                      <i class="fa fa-eye"></i>
                  </button>
              </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- PAGINACIÓN -->
    <div class="d-flex justify-content-center mt-3" *ngIf="ventasFiltradas.length > 0">
      <pagination-controls
        previousLabel="Anterior"
        nextLabel="Siguiente"
        (pageChange)="paginaActual = $event"
        [maxSize]="5"
        [responsive]="true"
        class="pagination-sm">
      </pagination-controls>
    </div>

  </div>
</div>

<!-- MODAL DETALLE VENTA -->
<div class="modal fade" tabindex="-1" [ngClass]="{'show d-block': mostrarModalDetalle}" id="modalDetalleVenta" role="dialog">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content shadow-lg">
      <div id="detalle-para-imprimir">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fa fa-receipt me-2"></i>Detalle de Venta
          </h5>
          <button type="button" class="btn-close btn-close-white no-print" aria-label="Close" (click)="cerrarModalDetalle()"></button>
        </div>
        <div class="modal-body p-4" *ngIf="ventaSeleccionadaParaDetalle">
          <!-- contenido igual que antes -->
          <div class="row mb-4">
            <div class="col-md-6 d-flex align-items-center">
              <span class="form-label fw-semibold text-secondary me-2 mb-0">Cliente:</span>
              <div class="form-control-plaintext pb-2">{{ventaSeleccionadaParaDetalle.clienteNombre || 'N/A'}}</div>
            </div>
            <div class="col-md-6 d-flex align-items-center">
              <span class="form-label fw-semibold text-secondary me-2 mb-0">Fecha:</span>
              <div class="form-control-plaintext pb-2">{{ventaSeleccionadaParaDetalle.fecha | date:'dd/MM/yyyy hh:mm a':'GMT-0500'}}</div>

            </div>
          </div>
          <div class="row mb-4">
            <div class="col-md-4 d-flex align-items-center">
              <span class="form-label fw-semibold text-secondary me-2 mb-0">Comprobante:</span>
              <div class="form-control-plaintext pb-2">{{ventaSeleccionadaParaDetalle.tipoComprobante}} {{ventaSeleccionadaParaDetalle.serie}}-{{ventaSeleccionadaParaDetalle.numeroComprobante}}</div>
            </div>
            <div class="col-md-4 d-flex align-items-center">
              <span class="form-label fw-semibold text-secondary me-2 mb-0">Forma de Pago:</span>
              <div class="form-control-plaintext pb-2">{{ ventaSeleccionadaParaDetalle.formaPago || 'N/A' }}</div>
            </div>
            <div class="col-md-4 d-flex align-items-center">
                <span class="form-label fw-semibold text-secondary me-2 mb-0">Estado:</span>
                <div class="form-control-plaintext pb-2">{{ ventaSeleccionadaParaDetalle.estado }}</div>
            </div>
          </div>
          <h6 class="mt-4 mb-3 border-bottom pb-2 fw-semibold text-primary"><i class="fa fa-list-alt me-2"></i>Detalles</h6>
          <div class="table-responsive">
            <table class="table table-bordered table-hover table-sm">
              <thead class="table-light">
                <tr>
                  <th>Descripción</th>
                  <th class="text-center">Talla</th>
                  <th class="text-end">Precio</th>
                  <th class="text-center">Cantidad</th>
                  <th class="text-end">Sub. Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="!ventaSeleccionadaParaDetalle.detalles || ventaSeleccionadaParaDetalle.detalles.length === 0">
                  <td colspan="5" class="text-center text-muted py-3">No hay detalles para esta venta.</td>
                </tr>
                <tr *ngFor="let detalle of ventaSeleccionadaParaDetalle.detalles">
                  <td>{{ detalle.nombreProducto }}</td>
                  <td class="text-center">{{ detalle.talla }}</td>
                  <td class="text-end">S/ {{ detalle.precio | number:'1.2-2' }}</td>
                  <td class="text-center">{{ detalle.cantidad }}</td>
                  <td class="text-end">S/ {{ detalle.total | number:'1.2-2' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="row justify-content-end mt-4">
            <div class="col-md-5">
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      Subtotal:
                      <span>S/ {{ (ventaSeleccionadaParaDetalle.total || 0) - (ventaSeleccionadaParaDetalle.totalIgv || 0) | number:'1.2-2' }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      IGV (18%):
                      <span>S/ {{ ventaSeleccionadaParaDetalle.totalIgv | number:'1.2-2' }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center fw-bold text-primary">
                      TOTAL:
                      <span class="fs-5">S/ {{ ventaSeleccionadaParaDetalle.total | number:'1.2-2' }}</span>
                    </li>
                  </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer bg-light no-print">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalDetalle()">Cerrar</button>
        <button type="button" class="btn btn-primary" (click)="imprimirDetalle()">
          <i class="fa fa-print me-1"></i> Imprimir
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ---------- BLOQUE OCULTO QUE CONTIENE TODAS LAS VENTAS (para generar PDF) ---------- -->
<!-- Está posicionado fuera de la vista para no afectar la UI pero html2canvas lo puede renderizar -->
<div id="listado-para-imprimir-todo" class="hidden-print-area">
  <div class="print-header" style="padding:12px 0; border-bottom:1px solid #ddd; margin-bottom:8px;">
    <h3 style="margin:0; font-size:18px;">Listado de Ventas (Todas)</h3>
    <div style="font-size:12px; color:#666;">Generado: {{ (now | date:'dd/MM/yyyy HH:mm':'GMT-0500') }}</div>

  </div>

  <table class="table table-bordered align-middle table-sm" style="width:100%; border-collapse:collapse;">
    <thead style="background:#17a2b8; color:#fff;">
      <tr>
        <th style="padding:6px;">Cliente</th>
        <th style="padding:6px;">Comprobante</th>
        <th style="padding:6px;">Correlativo</th>
        <th style="padding:6px;">Monto</th>
        <th style="padding:6px;">Fecha</th>
        <th style="padding:6px;">Estado</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let venta of ventas">
        <td style="padding:6px;">{{ venta.clienteNombre || 'N/A' }}</td>
        <td style="padding:6px;">{{ venta.tipoComprobante }}</td>
        <td style="padding:6px;">{{ venta.serie }}-{{ venta.numeroComprobante }}</td>
        <td style="padding:6px;">S/ {{ venta.total | number:'1.2-2' }}</td>
        <td style="padding:6px;">{{ venta.fecha | date:'dd/MM/yyyy hh:mm a':'GMT-0500' }}</td>

        <td style="padding:6px;">{{ venta.estado }}</td>
      </tr>
      <tr *ngIf="ventas.length === 0">
        <td colspan="6" style="text-align:center; padding:12px; color:#888;">No hay ventas registradas.</td>
      </tr>
    </tbody>
  </table>
</div>