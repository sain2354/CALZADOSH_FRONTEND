<!-- layout-tienda.component.html -->
<header class="site-header" role="banner">
  <div class="header-container">
    <div class="header-left">
      <a routerLink="/" class="logo" aria-label="Ir a inicio">
        <img src="assets/images/LOGO.png" alt="Logo de la Tienda">
      </a>
    </div>

    <div class="header-center" (mouseleave)="onHoverCategory(null)">
      <nav class="main-nav" aria-label="Navegación principal">
        <button class="nav-btn"
                (click)="selectCategory('Todos')"
                (mouseenter)="onHoverCategory(null)"
                [class.active]="selectedCategoryName === 'Todos'">
          Todos
        </button>

        <div class="nav-item-with-dropdown"
             (mouseenter)="onHoverCategory('Hombres')"
             (mouseleave)="onHoverCategory(null)">
          <button class="nav-btn" (click)="selectCategory('Hombres')" [class.active]="selectedCategoryName === 'Hombres'">
            Hombres
          </button>

          <div class="brands-dropdown fullwidth" *ngIf="hoveredCategoryName === 'Hombres'">
            <div class="filters-fullwidth">
              <div class="filter-block">
                <h4>GÉNERO</h4>
                <div class="filter-chips">
                  <button class="chip" *ngFor="let g of filterOptions.generos"
                          (click)="toggleChip('generos', g)"
                          [class.chip-active]="isChipActive('generos', g)">
                    {{ g }}
                  </button>
                </div>
              </div>

              <div class="filter-block">
                <h4>ARTÍCULO</h4>
                <div class="filter-chips">
                  <button class="chip" *ngFor="let a of filterOptions.articulos"
                          (click)="toggleChip('articulos', a)"
                          [class.chip-active]="isChipActive('articulos', a)">
                    {{ a }}
                  </button>
                </div>
              </div>

              <div class="filter-block">
                <h4>ESTILO</h4>
                <div class="filter-chips">
                  <button class="chip" *ngFor="let e of filterOptions.estilos"
                          (click)="toggleChip('estilos', e)"
                          [class.chip-active]="isChipActive('estilos', e)">
                    {{ e }}
                  </button>
                </div>
              </div>

              <div class="filter-block">
                <h4>COLOR</h4>
                <div class="filter-chips">
                  <button class="chip" *ngFor="let c of filterOptions.colores"
                          (click)="toggleChip('colores', c)"
                          [class.chip-active]="isChipActive('colores', c)">
                    {{ c }}
                  </button>
                </div>
              </div>

              <div class="filter-block">
                <h4>TALLAS</h4>
                <div class="filter-chips wrap">
                  <button class="chip" *ngFor="let t of filterOptions.tallas"
                          (click)="toggleChip('tallas', t)"
                          [class.chip-active]="isChipActive('tallas', t)">
                    {{ t }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mujeres -->
        <div class="nav-item-with-dropdown"
             (mouseenter)="onHoverCategory('Mujeres')"
             (mouseleave)="onHoverCategory(null)">
          <button class="nav-btn" (click)="selectCategory('Mujeres')" [class.active]="selectedCategoryName === 'Mujeres'">
            Mujeres
          </button>

          <div class="brands-dropdown fullwidth" *ngIf="hoveredCategoryName === 'Mujeres'">
            <div class="filters-fullwidth">
              <div class="filter-block">
                <h4>GÉNERO</h4>
                <div class="filter-chips">
                  <button class="chip" *ngFor="let g of filterOptions.generos"
                          (click)="toggleChip('generos', g)"
                          [class.chip-active]="isChipActive('generos', g)">
                    {{ g }}
                  </button>
                </div>
              </div>

              <div class="filter-block">
                <h4>ARTÍCULO</h4>
                <div class="filter-chips">
                  <button class="chip" *ngFor="let a of filterOptions.articulos"
                          (click)="toggleChip('articulos', a)"
                          [class.chip-active]="isChipActive('articulos', a)">
                    {{ a }}
                  </button>
                </div>
              </div>

              <div class="filter-block">
                <h4>ESTILO</h4>
                <div class="filter-chips">
                  <button class="chip" *ngFor="let e of filterOptions.estilos"
                          (click)="toggleChip('estilos', e)"
                          [class.chip-active]="isChipActive('estilos', e)">
                    {{ e }}
                  </button>
                </div>
              </div>

              <div class="filter-block">
                <h4>COLOR</h4>
                <div class="filter-chips">
                  <button class="chip" *ngFor="let c of filterOptions.colores"
                          (click)="toggleChip('colores', c)"
                          [class.chip-active]="isChipActive('colores', c)">
                    {{ c }}
                  </button>
                </div>
              </div>

              <div class="filter-block">
                <h4>TALLAS</h4>
                <div class="filter-chips wrap">
                  <button class="chip" *ngFor="let t of filterOptions.tallas"
                          (click)="toggleChip('tallas', t)"
                          [class.chip-active]="isChipActive('tallas', t)">
                    {{ t }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Infantil -->
        <div class="nav-item-with-dropdown"
             (mouseenter)="onHoverCategory('Infantil')"
             (mouseleave)="onHoverCategory(null)">
          <button class="nav-btn" (click)="selectCategory('Infantil')" [class.active]="selectedCategoryName === 'Infantil'">
            Infantil
          </button>

          <div class="brands-dropdown fullwidth" *ngIf="hoveredCategoryName === 'Infantil'">
            <div class="filters-fullwidth">
              <div class="filter-block">
                <h4>GÉNERO</h4>
                <div class="filter-chips">
                  <button class="chip" *ngFor="let g of filterOptions.generos"
                          (click)="toggleChip('generos', g)"
                          [class.chip-active]="isChipActive('generos', g)">
                    {{ g }}
                  </button>
                </div>
              </div>

              <div class="filter-block">
                <h4>ARTÍCULO</h4>
                <div class="filter-chips">
                  <button class="chip" *ngFor="let a of filterOptions.articulos"
                          (click)="toggleChip('articulos', a)"
                          [class.chip-active]="isChipActive('articulos', a)">
                    {{ a }}
                  </button>
                </div>
              </div>

              <div class="filter-block">
                <h4>ESTILO</h4>
                <div class="filter-chips">
                  <button class="chip" *ngFor="let e of filterOptions.estilos"
                          (click)="toggleChip('estilos', e)"
                          [class.chip-active]="isChipActive('estilos', e)">
                    {{ e }}
                  </button>
                </div>
              </div>

              <div class="filter-block">
                <h4>COLOR</h4>
                <div class="filter-chips">
                  <button class="chip" *ngFor="let c of filterOptions.colores"
                          (click)="toggleChip('colores', c)"
                          [class.chip-active]="isChipActive('colores', c)">
                    {{ c }}
                  </button>
                </div>
              </div>

              <div class="filter-block">
                <h4>TALLAS</h4>
                <div class="filter-chips wrap">
                  <button class="chip" *ngFor="let t of filterOptions.tallas"
                          (click)="toggleChip('tallas', t)"
                          [class.chip-active]="isChipActive('tallas', t)">
                    {{ t }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- BOTÓN MARCAS (al lado derecho de los botones de categoría) -->
        <div class="nav-item-brands">
          <button class="nav-btn" aria-haspopup="true" aria-expanded="false">Marcas</button>

          <!-- dropdown pequeño con las marcas solicitadas -->
          <div class="brand-dropdown" role="menu" aria-label="Marcas">
            <ul>
              <li *ngFor="let m of marcasList">
                <button class="brand-short-btn" (click)="selectBrandByName(m)">{{ m }}</button>
              </li>
            </ul>
          </div>
        </div>

      </nav>
    </div>

    <div class="header-right" role="navigation" aria-label="Acciones">
      <form (submit)="onSearch()" class="search-form" role="search" aria-label="Buscar productos">
        <input type="search" name="q" placeholder="BUSCAR" [(ngModel)]="searchTerm" (keydown.enter)="onSearch()" />
        <button type="button" class="search-btn" (click)="onSearch()" aria-label="Buscar">
          <i class="fas fa-search"></i>
        </button>
      </form>

      <!-- ====== INICIO DE LA MODIFICACIÓN PRECISA (VERSIÓN CLICK) ====== -->
      <div class="user-menu-container">
        <button class="header-icon user-icon-btn" (click)="toggleUserMenu()" aria-label="Menú de usuario">
          <i class="fas" [class.fa-user]="!(currentUser$ | async)" [class.fa-user-check]="!!(currentUser$ | async)"></i>
        </button>
        
        <div class="user-dropdown" *ngIf="isUserMenuOpen">
          <ng-container *ngIf="currentUser$ | async as user; else showLoginButton">
            <!-- Contenido para usuario LOGUEADO -->
            <div class="user-info">
              <p>Conectado como:</p>
              <strong>{{ user.email }}</strong>
            </div>
            <hr>
            <a routerLink="/mis-pedidos" class="user-dropdown-btn" (click)="toggleUserMenu()">Mis Pedidos</a>
            <a routerLink="/favoritos" class="user-dropdown-btn" (click)="toggleUserMenu()">Mis Favoritos</a>
            <button class="user-dropdown-btn" (click)="onSignOut()">Cerrar Sesión</button>
          </ng-container>

          <ng-template #showLoginButton>
            <!-- Contenido para usuario NO logueado -->
            <button class="user-dropdown-btn" (click)="goToLogin()">Iniciar Sesión</button>
          </ng-template>
        </div>
      </div>
      <!-- ====== FIN DE LA MODIFICACIÓN PRECISA ====== -->
      
      <button (click)="setCartVisible(!isCartVisible)" class="header-icon cart-icon-link" aria-label="Abrir o cerrar carrito">
        <i class="fas fa-shopping-bag"></i>
        <ng-container *ngIf="cartItemCount$ | async as count">
          <span *ngIf="count > 0" class="cart-badge">{{ count }}</span>
        </ng-container>
      </button>
    </div>
  </div>
</header>

<!-- === MODIFICACIÓN: Se elimina la clase 'content-shell' para arreglar el scroll === -->
<main class="main-content" role="main">
  <router-outlet></router-outlet>
</main>

<footer class="site-footer" role="contentinfo">
  <div class="footer-main">
    <div class="footer-container">
      <!-- contenido del footer -->
    </div>
  </div>
  <div class="footer-bottom">
    <div class="footer-container">
      <div class="company-info"><h4>FUTURE VISIONS</h4><p>RUC: 2006250858</p><p>Razón Social: FUTURE VISIONS GALAXY S.C.R.L.</p></div>
      <div class="copyright"><p>FUTURE VISIONS © 2024, ALL RIGHTS RESERVED</p></div>
    </div>
  </div>
</footer>

<app-cart *ngIf="isCartVisible" (close)="setCartVisible(false)"></app-cart>
