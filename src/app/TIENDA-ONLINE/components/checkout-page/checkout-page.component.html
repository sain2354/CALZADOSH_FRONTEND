
<div class="checkout-container">

  <div class="flow-indicator">
    <span>Carrito</span> &gt; <span class="current">Envío</span> &gt; <span>Pago</span>
  </div>

  <h2>Elige una opción de entrega</h2>

  <div class="shipping-options">
    <div class="option" style="display: none;">
      <input type="radio" id="recojo" name="shipping" value="tienda" (change)="selectShippingOption('tienda')">
      <label for="recojo">
        <strong>Recojo en Tienda</strong>
        <p>Recoge tu pedido sin costo adicional.</p>
      </label>
    </div>
    <div class="option">
      <input type="radio" id="domicilio" name="shipping" value="domicilio" (change)="selectShippingOption('domicilio')" checked>
      <label for="domicilio">
        <strong>Envío a Domicilio</strong>
        <p>Envíos vía Shalom (Costo adicional por definir).</p>
      </label>
    </div>
  </div>

  <div *ngIf="selectedShippingOption === 'domicilio'" class="shipping-cost">
    <h3>Costo de Envío</h3>
    <p>{{ costoEnvio | currency:'S/' }}</p>
  </div>

  <div *ngIf="selectedShippingOption === 'tienda'" class="store-pickup-info">
    <h3>Información para el Recojo</h3>
    <div class="store-details">
      <p><strong>Dirección:</strong> Av. Principal 123, Centro, Tu Ciudad</p>
      <p><strong>Horario:</strong> Lunes a Sábado de 9:00 AM - 7:00 PM</p>
      <p>Recibirás una notificación cuando tu pedido esté listo para ser recogido.</p>
    </div>
    <button (click)="handleSubmit()" class="submit-btn">
      Confirmar Recojo y Continuar con el Pago
    </button>
  </div>

  <div *ngIf="selectedShippingOption === 'domicilio'" class="shipping-form-container">
    <h3>Completa tus datos para el envío</h3>
    <form [formGroup]="shippingForm" (ngSubmit)="handleSubmit()" class="shipping-form">
      
      <div class="form-row">
        <div class="form-group">
          <label for="nombre">Nombres</label>
          <input id="nombre" type="text" formControlName="nombre">
        </div>
        <div class="form-group">
          <label for="apellido">Apellidos</label>
          <input id="apellido" type="text" formControlName="apellido">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="dni">DNI</label>
          <input id="dni" type="text" formControlName="dni">
        </div>
        <div class="form-group">
          <label for="telefono">Número de Teléfono</label>
          <input id="telefono" type="tel" formControlName="telefono">
        </div>
      </div>

      <!-- =============== INICIO BLOQUE UBIGEO (VERSIÓN CORREGIDA) =============== -->
      <div class="form-row">
        
        <!-- DEPARTAMENTOS -->
        <div class="form-group">
          <label for="departamento">Departamento</label>
          <!-- Usamos *ngIf para asegurar que el select se renderice solo cuando haya datos -->
          <ng-container *ngIf="departamentos$ | async as departamentos">
            <select id="departamento" class="form-control" formControlName="departamento" (change)="onDepartamentoChange()">
              <option [ngValue]="null" disabled>Selecciona un departamento</option>
              <option *ngFor="let dep of departamentos" [value]="dep">{{ dep }}</option>
            </select>
          </ng-container>
        </div>

        <!-- PROVINCIAS -->
        <div class="form-group">
          <label for="provincia">Provincia</label>
          <ng-container *ngIf="provincias$ | async as provincias">
            <select id="provincia" class="form-control" formControlName="provincia" (change)="onProvinciaChange()">
              <option [ngValue]="null" disabled>Selecciona una provincia</option>
              <!-- Si el array de provincias está vacío, no se mostrará ninguna opción -->
              <option *ngFor="let prov of provincias" [value]="prov">{{ prov }}</option>
            </select>
          </ng-container>
        </div>

        <!-- DISTRITOS -->
        <div class="form-group">
          <label for="distrito">Distrito</label>
          <ng-container *ngIf="distritos$ | async as distritos">
            <select id="distrito" class="form-control" formControlName="distrito">
              <option [ngValue]="null" disabled>Selecciona un distrito</option>
              <option *ngFor="let dist of distritos" [value]="dist">{{ dist }}</option>
            </select>
          </ng-container>
        </div>

      </div>
      <!-- =============== FIN BLOQUE UBIGEO =============== -->

      <div class="form-group address-group">
        <label for="direccion">Dirección</label>
        <input id="direccion" type="text" formControlName="direccion" placeholder="Ej: Av. El Sol 456">
      </div>

      <div class="form-group address-group">
        <label for="referencia">Referencia (Opcional)</label>
        <textarea id="referencia" formControlName="referencia" rows="3" placeholder="Ej: Frente a la plaza, casa de color azul"></textarea>
      </div>

      <button type="submit" class="submit-btn" [disabled]="shippingForm.invalid">
        Continuar con el Pago
      </button>
      <div *ngIf="shippingForm.invalid && (shippingForm.dirty || shippingForm.touched)" class="error-message">
        Por favor, completa todos los campos requeridos.
      </div>

    </form>
  </div>

</div>
